<p-toast></p-toast>

<div class="admin-container">
    <app-sidebar></app-sidebar>
    <header class="admin-header">
        <h1>User Management</h1>
        <p class="subtitle">Manage users and view their participations</p>
    </header>

    <main class="content-area">
        <!-- Filter Section -->
        <section class="filter-section">
            <div class="filter-card">
                <h3>Filter Users by Participation</h3>
                <div class="filter-controls">
                    <p-dropdown 
                        [options]="filterOptions" 
                        [(ngModel)]="selectedFilterType" 
                        (onChange)="onFilterChange()"
                        placeholder="Select filter type"
                        optionLabel="label" 
                        optionValue="value"
                        styleClass="filter-dropdown">
                    </p-dropdown>
                    <span class="filter-info">
                        Showing {{filteredUtilisateurs.length}} of {{utilisateurs.length}} users
                    </span>
                </div>
            </div>
        </section>

        <!-- User List -->
        <section class="list-section">
            <div class="list-card">
                <header class="card-header">
                    <h2>User List with Participations</h2>
                    <i class="pi pi-users"></i>
                </header>
                
                <p-table [value]="filteredUtilisateurs" 
                    [paginator]="true" 
                    [rows]="10" 
                    [showCurrentPageReport]="true"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users"
                    [rowsPerPageOptions]="[5,10,20,50]"
                    styleClass="p-datatable-gridlines p-datatable-sm"
                    [tableStyle]="{'min-width': '80rem'}"
                    responsiveLayout="scroll"
                    [loading]="loading">
                    
                    <ng-template pTemplate="header">
                        <tr>
                            <th>ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Age</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Participations Summary</th>
                            <th>Actions</th>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="body" let-utilisateur>
                        <tr>
                            <td>{{utilisateur.id}}</td>
                            <td>{{utilisateur.prenom}} {{utilisateur.nom}}</td>
                            <td>{{utilisateur.email}}</td>
                            <td>{{utilisateur.age}}</td>
                            <td>{{utilisateur.numero}}</td>
                            <td>
                                <p-tag 
                                    [value]="utilisateur.role || 'USER'" 
                                    [severity]="utilisateur.role === 'ADMIN' ? 'danger' : 'info'">
                                </p-tag>
                            </td>
                            <td>
                                <p-tag 
                                    [value]="utilisateur.statut ? 'Active' : 'Inactive'" 
                                    [severity]="utilisateur.statut ? 'success' : 'warning'">
                                </p-tag>
                            </td>
                            <td class="participations-cell">
                                <div class="participations-summary">
                                    {{getParticipationSummary(utilisateur)}}
                                </div>
                                <div class="participations-details" *ngIf="utilisateur.participations">
                                    <!-- Events -->
                                    <div *ngIf="utilisateur.participations.evenements.length > 0" class="participation-group">
                                        <strong>Events:</strong>
                                        <ul class="participation-list">
                                            <li *ngFor="let event of utilisateur.participations.evenements">
                                                {{event.nom || event.title || 'Unknown Event'}}
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <!-- Formations -->
                                    <div *ngIf="utilisateur.participations.formations.length > 0" class="participation-group">
                                        <strong>Formations:</strong>
                                        <ul class="participation-list">
                                            <li *ngFor="let formation of utilisateur.participations.formations">
                                                {{formation.nom || formation.title || 'Unknown Formation'}}
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <!-- Ateliers -->
                                    <div *ngIf="utilisateur.participations.sousAteliers.length > 0" class="participation-group">
                                        <strong>Ateliers:</strong>
                                        <ul class="participation-list">
                                            <li *ngFor="let atelier of utilisateur.participations.sousAteliers">
                                                {{atelier.nom || atelier.name || 'Unknown Atelier'}}
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                            <td class="actions-cell">
                                <div class="action-buttons">
                                    <p-button 
                                        icon="pi pi-eye" 
                                        styleClass="p-button-rounded p-button-info p-button-sm" 
                                        pTooltip="View Details"
                                        tooltipPosition="top">
                                    </p-button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="9" class="empty-message">
                                <i class="pi pi-info-circle"></i>
                                <span>No users found matching the selected filter</span>
                            </td>
                        </tr>
                    </ng-template>
                    
                    <ng-template pTemplate="loadingbody">
                        <tr>
                            <td colspan="9" class="loading-message">
                                <i class="pi pi-spin pi-spinner"></i>
                                <span>Loading user data and participations...</span>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </section>
    </main>
</div>

<p-confirmDialog [style]="{width: '50vw'}" [baseZIndex]="10000" rejectButtonStyleClass="p-button-text"></p-confirmDialog>